{
  "reviewer": "quinn",
  "pr_number": 112,
  "review_round": 1,
  "timestamp": "2026-01-22T23:30:00Z",
  "verdict": "BLOCK",
  "summary": "8 issues found: 2 CRITICAL (NULL handling, backfill), 3 HIGH (ON CONFLICT, NULL safety, integration tests), 3 MEDIUM (FK validation, Optional params, dry run)",
  "functional_test_required": true,
  "functional_test_reason": "PR modifies core pipeline data flow (classification → storage → theme extraction). Must verify: (1) migration on production-like DB, (2) NULL conversation handling, (3) theme extraction correctness, (4) run immutability on re-classification, (5) FK constraint enforcement",
  "issues": [
    {
      "id": "Q1",
      "severity": "CRITICAL",
      "confidence": "high",
      "category": "quality-impact",
      "file": "src/db/migrations/010_conversation_run_scoping.sql",
      "lines": [10, 10],
      "title": "NULL pipeline_run_id creates data black hole for existing conversations",
      "why": "Migration adds nullable column without backfill. All existing conversations get pipeline_run_id=NULL. Theme extraction query (line 298 in pipeline.py) uses WHERE c.pipeline_run_id=%s, excluding NULL values. Historical conversations become permanently invisible.",
      "fix": "Add backfill logic to migration using timestamp heuristic: UPDATE conversations SET pipeline_run_id = (SELECT id FROM pipeline_runs WHERE classified_at >= started_at ORDER BY started_at DESC LIMIT 1) WHERE pipeline_run_id IS NULL. OR add NULL fallback to theme extraction query.",
      "verify": null,
      "scope": "systemic",
      "see_verbose": true
    },
    {
      "id": "Q2",
      "severity": "CRITICAL",
      "confidence": "high",
      "category": "regression-risk",
      "file": "src/db/migrations/010_conversation_run_scoping.sql",
      "lines": [1, 18],
      "title": "No backfill strategy for historical data - permanent data loss",
      "why": "Migration has zero guidance for existing conversations. No backfill, no documentation, no follow-up plan. Production DB likely has thousands of conversations from past months that will all get NULL pipeline_run_id, making them unqueryable.",
      "fix": "Add backfill UPDATE statement to migration (see Q1). Document backfill accuracy limitations. Add pipeline_run_id_estimated BOOLEAN flag to track backfilled rows vs explicit associations.",
      "verify": "Count existing conversations in production. Estimate NULL percentage post-migration. Confirm acceptable data loss threshold with product owner.",
      "scope": "systemic",
      "see_verbose": true
    },
    {
      "id": "Q3",
      "severity": "HIGH",
      "confidence": "medium",
      "category": "system-conflict",
      "file": "src/db/classification_storage.py",
      "lines": [156, 156],
      "title": "ON CONFLICT UPDATE overwrites pipeline_run_id, breaking run immutability",
      "why": "Line 156 includes 'pipeline_run_id = EXCLUDED.pipeline_run_id' in ON CONFLICT UPDATE. Re-classifying a conversation changes which run it belongs to. Run 100 classifies conv ABC → run_id=100. Run 101 re-classifies ABC → run_id changes to 101. Run 100's theme extraction now missing ABC. Historical results change retroactively.",
      "fix": "Remove pipeline_run_id from ON CONFLICT UPDATE clause. Keep first classification's run association (immutable). OR add conversation_run_membership table for many-to-many tracking. OR add first_pipeline_run_id and latest_pipeline_run_id columns.",
      "verify": "How often are conversations re-classified? Does product need re-classification history?",
      "scope": "systemic",
      "see_verbose": true
    },
    {
      "id": "Q4",
      "severity": "HIGH",
      "confidence": "high",
      "category": "quality-impact",
      "file": "src/api/routers/pipeline.py",
      "lines": [298, 298],
      "title": "Theme extraction query has no NULL safety - silent data exclusion",
      "why": "Query uses WHERE c.pipeline_run_id = %s with no NULL handling. All existing conversations (NULL pipeline_run_id) are silently excluded. No error, no warning, output appears correct but missing data. User expects all recent conversations, only gets new ones.",
      "fix": "Add NULL safety: WHERE (c.pipeline_run_id = %s OR (c.pipeline_run_id IS NULL AND c.classified_at >= %s)). OR log warning when NULL rows found. OR add validation that fails if NULL rows exist.",
      "verify": null,
      "scope": "isolated",
      "see_verbose": true
    },
    {
      "id": "Q5",
      "severity": "HIGH",
      "confidence": "high",
      "category": "regression-risk",
      "file": "tests/test_run_scoping.py",
      "lines": [145, 214],
      "title": "Integration tests skipped - can't verify actual DB behavior",
      "why": "Both integration tests marked @pytest.mark.skip. These are the ONLY tests verifying DB behavior with pipeline_run_id. Can't verify: NULL handling, ON CONFLICT UPDATE, foreign key constraints, index performance. Regression risk extremely high.",
      "fix": "Unskip tests and add pytest-postgresql fixture. OR add to CI with ephemeral test DB. OR add Docker-based test DB for local dev. Document how to run integration tests manually.",
      "verify": null,
      "scope": "isolated",
      "see_verbose": true
    },
    {
      "id": "Q6",
      "severity": "MEDIUM",
      "confidence": "medium",
      "category": "quality-impact",
      "file": "src/api/routers/pipeline.py",
      "lines": [577, 577],
      "title": "No foreign key validation at API call site",
      "why": "API passes run_id as pipeline_run_id without verifying run exists. If run_id not in pipeline_runs table → FK violation → rollback → silent data loss. No clear error messaging for invalid run associations.",
      "fix": "Add assertion before pipeline: verify run_id exists in pipeline_runs. Add try/except around storage to catch FK violations. Log clear error: 'Invalid pipeline_run_id: {run_id} not found in pipeline_runs'.",
      "verify": null,
      "scope": "isolated",
      "see_verbose": true
    },
    {
      "id": "Q7",
      "severity": "MEDIUM",
      "confidence": "high",
      "category": "quality-impact",
      "file": "src/two_stage_pipeline.py",
      "lines": [421, 421],
      "title": "Optional[int] pipeline_run_id allows silent quality degradation",
      "why": "All pipeline functions accept Optional[int] pipeline_run_id. No enforcement for non-dry-run execution. Developer calls run_pipeline_async() without pipeline_run_id → processes 1000 conversations → stores all with NULL → theme extraction returns 0 rows later. Failure delayed to wrong layer.",
      "fix": "Add validation at pipeline start: if not dry_run and pipeline_run_id is None: raise ValueError('pipeline_run_id required for non-dry-run'). OR make pipeline_run_id required (not Optional). Add logging: logger.info(f'Pipeline run ID: {pipeline_run_id}').",
      "verify": null,
      "scope": "isolated",
      "see_verbose": true
    },
    {
      "id": "Q8",
      "severity": "MEDIUM",
      "confidence": "low",
      "category": "quality-impact",
      "file": "src/two_stage_pipeline.py",
      "lines": [576, 576],
      "title": "Dry run parameter validation unclear",
      "why": "In dry run mode, pipeline_run_id semantics unclear. Line 576 inside 'if not dry_run:' block won't execute, but parameter threading confusing. User might think dry_run means no DB writes but unclear if run association should still happen.",
      "fix": "Document dry_run behavior with pipeline_run_id. OR add assertion: if dry_run: assert pipeline_run_id is None.",
      "verify": null,
      "scope": "isolated",
      "see_verbose": false
    }
  ]
}
