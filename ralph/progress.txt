# Ralph Progress - Milestone 8 (Per-Issue Slices)
# Legacy history is preserved in ralph/progress_legacy.txt

=== Slice Start: #103 Fix run scoping: use pipeline_run_id instead of timestamp heuristics ===
- Date: 2026-01-22
- Branch: ralph/m8-103-run-scoping
- Notes: Initialized per-issue slice for Milestone 8.

=== Iteration 1: Implementation Complete ===
- Date: 2026-01-22
- Changes:
  1. Created migration 010_conversation_run_scoping.sql
     - Adds pipeline_run_id column to conversations table
     - Creates index for efficient run-scoped queries
  2. Updated src/db/classification_storage.py
     - store_classification_result() now accepts pipeline_run_id parameter
     - store_classification_results_batch() now accepts pipeline_run_id parameter
     - Both functions store pipeline_run_id in conversations table
  3. Updated src/two_stage_pipeline.py
     - run_pipeline_async() now accepts and passes pipeline_run_id
     - run_pipeline() (sync version) now accepts and passes pipeline_run_id
     - _run_coda_pipeline_async() now accepts and passes pipeline_run_id
     - All store_classification_results_batch() calls pass pipeline_run_id
  4. Updated src/api/routers/pipeline.py
     - _run_pipeline_task() passes run_id to run_pipeline_async()
     - Fixed timestamp heuristic in _run_theme_extraction():
       OLD: JOIN pipeline_runs pr ON c.classified_at >= pr.started_at
       NEW: WHERE c.pipeline_run_id = %s
  5. Created tests/test_run_scoping.py
     - Tests for storage function signatures
     - Tests for pipeline function signatures
     - Tests for migration existence
     - Tests for theme extraction query fix
     - Integration tests (skipped - require DB)
- Test Results:
  - All 7 run scoping tests PASSED (2 skipped - require DB)
  - Full backend test suite: 782 passed, 11 skipped, 1 failed (unrelated latency test)
  - Pipeline API tests: 30 passed
- Commit: 6bf9c79
- Push: Complete (branch: ralph/m8-103-run-scoping)

=== Iteration 2: PR Created + 5-Personality Review ===
- Date: 2026-01-22
- PR URL: https://github.com/paulyokota/FeedForward/pull/112
- Review Round 1:
  - Reginald (Architect): BLOCK - 4 HIGH issues (NULL handling, ON CONFLICT, FK)
  - Sanjay (Security): BLOCK - 2 CRITICAL issues (FK CASCADE, authorization)
  - Quinn (Quality): BLOCK - 2 CRITICAL issues (NULL black hole, backfill)
  - Dmitri (Pragmatist): APPROVE - 1 MEDIUM (pre-existing duplication)
  - Maya (Maintainer): APPROVE - 1 HIGH (unclear ON CONFLICT semantics)
- Fixes Applied (commit 9ab0441):
  1. NULL handling: Added timestamp fallback for pre-migration conversations
  2. ON CONFLICT: Use COALESCE to keep first run (immutable)
  3. FK CASCADE: Added ON DELETE SET NULL
  4. Documentation: Added backfill strategy and semantics comments
- Review Round 2: All 5 reviewers APPROVE
- Status: CONVERGED in 2 rounds
- PR #112 MERGED (squash) to main

=== Slice Complete: #103 ===
- Date: 2026-01-22
- Final Commit: a5d3327 (squash merge)
- Summary: Fix run scoping with backward-compatible NULL fallback
- Next Slice: #89 Pipeline-critical tests for canonical flow

=== Slice Start: #89 Pipeline-critical tests for canonical flow ===
- Date: 2026-01-22
- Branch: ralph/m8-89-pipeline-tests
- Notes: Next Phase 1 item per T-004 priority. Tests unblock #108, #109.

=== Iteration 1: Test Suite Implementation Complete ===
- Date: 2026-01-22
- Changes:
  1. Created tests/test_pipeline_canonical_flow.py (29 tests)
     - TestPipelineFlowIntegration (4 tests):
       * test_theme_groups_create_stories_when_large_enough
       * test_theme_groups_create_orphans_when_too_small
       * test_mixed_groups_processed_correctly
       * test_processing_result_metrics_accurate
     - TestStoryCreationServiceBehavior (5 tests):
       * test_min_group_size_boundary_story (exactly MIN_GROUP_SIZE → story)
       * test_min_group_size_boundary_orphan (MIN_GROUP_SIZE-1 → orphan)
       * test_empty_conversation_id_rejected
       * test_orphan_integration_used_when_available
       * test_orphan_fallback_on_integration_failure
     - TestQualityGateRegression (4 tests):
       * test_confidence_score_stored_on_story
       * test_confidence_below_threshold_creates_orphan
       * test_evidence_validation_failure_routes_to_orphan
       * test_quality_gate_result_captures_failure_reason
     - TestEvidenceValidator (6 tests):
       * test_valid_samples_pass
       * test_missing_id_fails
       * test_missing_excerpt_fails
       * test_placeholder_excerpt_fails
       * test_empty_samples_fails
       * test_coverage_calculated_correctly
     - TestRunScopingIsolation (3 tests):
       * test_stories_linked_to_pipeline_run_id
       * test_processing_result_tracks_story_ids
       * test_separate_runs_create_separate_stories
     - TestPMReviewMetrics (2 tests):
       * test_pm_review_skipped_when_disabled
       * test_pm_review_metrics_initialized
     - TestErrorHandling (2 tests):
       * test_exception_in_one_group_doesnt_stop_others
       * test_story_service_exception_captured
     - TestConstants (3 tests):
       * test_min_group_size_is_3
       * test_default_confidence_threshold_is_50
       * test_processing_result_has_quality_gate_metrics
- Test Results:
  - All 29 new tests PASSED
  - Full backend test suite: 840 passed, 11 skipped, 1 failed (pre-existing latency test)
- Coverage per Issue Acceptance Criteria:
  [x] Tests validate canonical pipeline flow end-to-end with minimal fixtures
  [x] Quality gate logic is exercised (confidence, evidence validation, orphan path)
  [x] Run scoping isolation is tested (no cross-contamination)
  [x] Tests are stable and do not depend on live API calls
- Commit: 45dd93e
- Push: Complete (branch: ralph/m8-89-pipeline-tests)

=== Iteration 2: PR + 5-Personality Review ===
- Date: 2026-01-22
- PR URL: https://github.com/paulyokota/FeedForward/pull/113
- Review Round 1:
  - Reginald (Architect): BLOCK - Mock DB cursor, empty ID verification, orphan assertion
  - Sanjay (Security): APPROVE - No security concerns
  - Quinn (QA): BLOCK - End-to-end test (acknowledged), evidence validation assertion
  - Dmitri (Minimalist): BLOCK - Stylistic concerns (later retracted)
  - Maya (Maintainer): APPROVE - Excellent maintainability
- Fixes Applied (commit 6babb88):
  1. Mock DB cursor: Use MagicMock with proper __enter__/__exit__ pattern
  2. Empty ID test: Add create.call_count == 0 assertion
  3. Orphan fallback: Split into two assertions (fallbacks AND creation)
  4. Evidence validation: Add orphan creation verification
- Review Round 2: All 5 reviewers APPROVE
- Status: CONVERGED in 2 rounds
- PR #113 MERGED (squash) to main

=== Slice Complete: #89 ===
- Date: 2026-01-22
- Final Commit: 5033f5a (squash merge)
- Summary: 29 pipeline-critical tests for canonical flow (classification → theme → story)
- Unblocks: #108 (embedding clustering), #109 (PM review)
- Next Slice: Select from SLICE.md

=== Slice Start: #104 Theme extraction quality gates + error propagation to UI ===
- Date: 2026-01-22
- Branch: ralph/m8-104-quality-gates
- Notes: Phase 1 issue per T-004 priority. Blocks #110.

=== Iteration 1: Implementation Complete ===
- Date: 2026-01-22
- Changes:
  Part A: Theme Quality Gates
  1. Created src/theme_quality.py
     - check_theme_quality() validates individual themes
     - filter_themes_by_quality() filters batches with warnings
     - Quality score = confidence (high=1.0, medium=0.6, low=0.2) + vocabulary bonus (0.2)
     - QUALITY_THRESHOLD = 0.3 (configurable)
     - FILTERED_SIGNATURES: unclassified_needs_review, unknown_issue, other_issue
  2. Created tests/test_theme_quality.py (22 tests)
  3. Created src/db/migrations/011_quality_gates.sql
     - themes_filtered INTEGER on pipeline_runs
     - errors JSONB, warnings JSONB on pipeline_runs
     - quality_score REAL, quality_details JSONB on themes

  Part B: Error Propagation
  4. Updated src/api/schemas/pipeline.py
     - Added PipelineError model {phase, message, details}
     - Added themes_filtered, errors, warnings to PipelineStatus
     - Added error_count to PipelineRunListItem
  5. Updated src/db/models.py
     - Added themes_filtered, errors (List[dict]), warnings (List[str])

  Part C: UI Messaging
  6. Updated src/api/routers/pipeline.py
     - Integrated filter_themes_by_quality() in _run_theme_extraction()
     - Fixed stories_ready = themes_extracted > 0 (not True when all filtered)
     - Renamed variables: high_quality_themes, low_quality_themes
  7. Updated webapp/src/lib/types.ts
     - Added PipelineError interface
     - Added themes_filtered, errors, warnings to PipelineStatus
  8. Updated webapp/src/app/pipeline/page.tsx
     - Added warnings section with collapsible display
     - Added "All Themes Filtered" panel with actionable guidance
     - Added themes_filtered display in stats grid

- Test Results:
  - All 22 theme quality tests PASSED
  - All 15 pipeline router tests PASSED
  - Webapp build successful
- Commit: ef05bad
- Push: Complete (branch: ralph/m8-104-quality-gates)

=== Iteration 2: PR + 5-Personality Review ===
- Date: 2026-01-22
- PR URL: https://github.com/paulyokota/FeedForward/pull/114
- Review Round 1: All 5 APPROVE with issues
  - Q1 (HIGH): "All Themes Filtered" lacks actionable guidance
  - R1 (MEDIUM): Type annotations in PipelineRun
  - S1 (MEDIUM): Warning sanitization (don't expose conv IDs)
  - M1 (MEDIUM): Variable naming clarity
- Fixes Applied (commits 6fdd37e, 7f85b80):
  1. Q1: Added actionable guidance with 3 suggestions
  2. R1: List[dict] and List[str] type annotations
  3. S1: Removed conversation IDs from warnings
  4. M1: high_quality_themes / low_quality_themes
  5. R2-1: Complete return dict structure in early returns
- Review Round 2: 4 APPROVE, 1 BLOCK (Reginald - R2-1)
- Review Round 3: Reginald APPROVE after R2-1 fix
- Status: CONVERGED in 3 rounds
- PR #114 MERGED (squash) to main

=== Slice Complete: #104 ===
- Date: 2026-01-22
- Final Commit: 80ff594 (squash merge)
- Summary: Theme quality gates + error propagation + UI improvements
- Unblocks: #110 (theme vocabulary expansion)
- Next Slice: #105 Data model: conversation_embeddings and conversation_facets tables

=== Slice Start: #105 Data model: conversation_embeddings and conversation_facets tables ===
- Date: 2026-01-22
- Branch: ralph/m8-105-data-model
- Notes: First Phase 2 issue. Creates tables for embedding-based clustering infrastructure.

=== Iteration 1: Implementation Complete ===
- Date: 2026-01-22
- Changes:
  1. Created migration 012_conversation_embeddings_facets.sql
     - conversation_embeddings table with vector(1536), HNSW index
     - conversation_facets table with action_type, direction, symptom, user_goal
     - Composite indexes on (pipeline_run_id, conversation_id) for run scoping
     - Documentation comments on all tables/columns
  2. Updated src/db/models.py
     - Added ActionType literal (8 values per T-006)
     - Added Direction literal (7 values per T-006)
     - Added ConversationEmbedding model
     - Added ConversationFacets model
  3. Created tests/test_embedding_facets_models.py (28 tests)
     - Model structure and defaults
     - Type literal validation
     - Migration file structure verification
     - Index existence checks
- Test Results:
  - All 28 new tests PASSED
  - Full backend suite: 890 passed, 2 failed (pre-existing latency test)
- Commit: 9c758e4
- Push: Complete (branch: ralph/m8-105-data-model)

=== Iteration 2: PR + 5-Personality Review ===
- Date: 2026-01-22
- PR URL: https://github.com/paulyokota/FeedForward/pull/115
- Review Round 1:
  - Reginald (Architect): BLOCK - 1 CRITICAL (UUID vs INTEGER), 2 HIGH (FK, Pydantic types)
  - Sanjay (Security): APPROVE - 2 MEDIUM (FK, length constraints)
  - Quinn (QA): BLOCK - 3 HIGH (empty embeddings, word count, index patterns)
  - Dmitri (Minimalist): BLOCK - 3 MEDIUM (YAGNI: content_hash, indexes, migration tests)
  - Maya (Maintainer): APPROVE - 1 HIGH (Pydantic V2), 3 MEDIUM (validation, naming, docs)
- Fixes Applied (commit 5aeffdc):
  1. pipeline_run_id: UUID → INTEGER to match pipeline_runs.id
  2. Added FK constraints with ON DELETE SET NULL
  3. Added embedding dimension validator (must be 1536)
  4. Added word count validator (symptom/user_goal ≤ 10 words)
  5. Removed content_hash (YAGNI)
  6. Renamed ConversationFacets → ConversationFacet
  7. Used ConfigDict (Pydantic V2)
  8. Added UNIQUE constraint on (conversation_id, pipeline_run_id)
  9. Reduced indexes, added inline docs for type literals
- Review Round 2: All 5 reviewers APPROVE
- Status: CONVERGED in 2 rounds
- PR #115 MERGED (squash) to main

=== Slice Complete: #105 ===
- Date: 2026-01-22
- Final Commit: d262f5d (squash merge)
- Summary: Data model for embedding-based clustering (conversation_embeddings + conversation_facet)
- Unblocks: #106 (embedding generation), #107 (facet extraction)
- Next Slice: #106 Pipeline step: embedding generation for conversations

=== Slice Start: #106 Pipeline step: embedding generation for conversations ===
- Date: 2026-01-22
- Branch: ralph/m8-106-embedding-generation
- Notes: First Phase 2 pipeline step. Generates embeddings via OpenAI API.

=== Iteration 1: Implementation Complete ===
- Date: 2026-01-22
- Changes:
  1. Created src/services/embedding_service.py
     - EmbeddingService with batch async/sync generation
     - OpenAI text-embedding-3-small (1536 dimensions)
     - DEFAULT_BATCH_SIZE = 50 for rate limit safety
     - _sanitize_error_message() for secure error handling
     - Response ordering fix (sort by index)
  2. Created src/db/embedding_storage.py
     - store_embedding() for single embeddings
     - store_embeddings_batch() for batch upsert (~50x faster)
     - get_embeddings_for_run() with error handling
     - Uses EMBEDDING_DIMENSIONS constant
  3. Created migration 013_embedding_generation_phase.sql
     - Adds embeddings_generated, embeddings_failed to pipeline_runs
  4. Updated src/api/routers/pipeline.py
     - Added _run_embedding_generation_async() phase
     - Integrated between classification and theme extraction
     - Documented asyncio.run() safety (background thread)
  5. Updated schemas/models for embedding fields
  6. Created tests/test_embedding_service.py (34 tests)
- Test Results:
  - All 34 embedding service tests PASSED
  - Full backend suite: 925 passed, 2 failed (pre-existing)
- Commit: ca980c0
- Push: Complete (branch: ralph/m8-106-embedding-generation)

=== Iteration 2: PR + 5-Personality Review ===
- Date: 2026-01-22
- PR URL: https://github.com/paulyokota/FeedForward/pull/116
- Review Round 1:
  - Reginald: BLOCK - 1 HIGH (R2: response ordering), 2 MEDIUM (R4/R5)
  - Sanjay: BLOCK - 3 MEDIUM (S-1/S-2/S-4: error exposure, resources, rate limits)
  - Quinn: BLOCK - 1 HIGH (Q-002: asyncio.run nesting), FUNCTIONAL_TEST_REQUIRED
  - Dmitri: CHANGES_REQUESTED - 7 YAGNI issues (deferred for clustering phase)
  - Maya: CHANGES_REQUESTED - 7 maintainability issues (M1/M3/M5 fixed)
- Fixes Applied (commit 2709a8b):
  1. R2: Sort response.data by index before mapping
  2. R4: Add try/except with logging for pgvector parsing
  3. M3/R5/Q-001: Use EMBEDDING_DIMENSIONS constant consistently
  4. M5: Fix misleading _prepare_text docstring
  5. S-1: Add _sanitize_error_message() for secure errors
  6. Q-002: Document asyncio.run() safety (background thread context)
  7. Updated tests for index attribute and sanitized errors
- Review Round 2: All 5 reviewers APPROVE
  - Reginald: All blocking issues resolved
  - Sanjay: S-1 fix verified
  - Quinn: APPROVE (pending functional test), Q-006 (LOW) deferred
  - Dmitri: No new complexity
  - Maya: Fixes verified
- Status: CONVERGED in 2 rounds
- FUNCTIONAL_TEST_REQUIRED: Quinn flagged - new pipeline phase needs functional test evidence

=== BLOCKED: Awaiting Functional Test ===
- Date: 2026-01-22
- PR URL: https://github.com/paulyokota/FeedForward/pull/116
- Reason: Quinn flagged FUNCTIONAL_TEST_REQUIRED for new pipeline phase
- Required: Run pipeline with embedding generation enabled, attach evidence
- Next Steps:
  1. Run functional test: python -m src.two_stage_pipeline --days 1 --max 5
  2. Verify embeddings stored in conversation_embeddings table
  3. Attach evidence to PR per docs/process-playbook/gates/functional-testing-gate.md
  4. Merge PR
  5. Update SLICE.md and continue to next issue
