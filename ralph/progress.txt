# Ralph Progress - Milestone 8 (Per-Issue Slices)
# Legacy history is preserved in ralph/progress_legacy.txt

=== Slice Start: #103 Fix run scoping: use pipeline_run_id instead of timestamp heuristics ===
- Date: 2026-01-22
- Branch: ralph/m8-103-run-scoping
- Notes: Initialized per-issue slice for Milestone 8.

=== Iteration 1: Implementation Complete ===
- Date: 2026-01-22
- Changes:
  1. Created migration 010_conversation_run_scoping.sql
     - Adds pipeline_run_id column to conversations table
     - Creates index for efficient run-scoped queries
  2. Updated src/db/classification_storage.py
     - store_classification_result() now accepts pipeline_run_id parameter
     - store_classification_results_batch() now accepts pipeline_run_id parameter
     - Both functions store pipeline_run_id in conversations table
  3. Updated src/two_stage_pipeline.py
     - run_pipeline_async() now accepts and passes pipeline_run_id
     - run_pipeline() (sync version) now accepts and passes pipeline_run_id
     - _run_coda_pipeline_async() now accepts and passes pipeline_run_id
     - All store_classification_results_batch() calls pass pipeline_run_id
  4. Updated src/api/routers/pipeline.py
     - _run_pipeline_task() passes run_id to run_pipeline_async()
     - Fixed timestamp heuristic in _run_theme_extraction():
       OLD: JOIN pipeline_runs pr ON c.classified_at >= pr.started_at
       NEW: WHERE c.pipeline_run_id = %s
  5. Created tests/test_run_scoping.py
     - Tests for storage function signatures
     - Tests for pipeline function signatures
     - Tests for migration existence
     - Tests for theme extraction query fix
     - Integration tests (skipped - require DB)
- Test Results:
  - All 7 run scoping tests PASSED (2 skipped - require DB)
  - Full backend test suite: 782 passed, 11 skipped, 1 failed (unrelated latency test)
  - Pipeline API tests: 30 passed
- Commit: 6bf9c79
- Push: Complete (branch: ralph/m8-103-run-scoping)

=== Iteration 2: PR Created + 5-Personality Review ===
- Date: 2026-01-22
- PR URL: https://github.com/paulyokota/FeedForward/pull/112
- Review Round 1:
  - Reginald (Architect): BLOCK - 4 HIGH issues (NULL handling, ON CONFLICT, FK)
  - Sanjay (Security): BLOCK - 2 CRITICAL issues (FK CASCADE, authorization)
  - Quinn (Quality): BLOCK - 2 CRITICAL issues (NULL black hole, backfill)
  - Dmitri (Pragmatist): APPROVE - 1 MEDIUM (pre-existing duplication)
  - Maya (Maintainer): APPROVE - 1 HIGH (unclear ON CONFLICT semantics)
- Fixes Applied (commit 9ab0441):
  1. NULL handling: Added timestamp fallback for pre-migration conversations
  2. ON CONFLICT: Use COALESCE to keep first run (immutable)
  3. FK CASCADE: Added ON DELETE SET NULL
  4. Documentation: Added backfill strategy and semantics comments
- Review Round 2: All 5 reviewers APPROVE
- Status: CONVERGED in 2 rounds
- PR #112 MERGED (squash) to main

=== Slice Complete: #103 ===
- Date: 2026-01-22
- Final Commit: a5d3327 (squash merge)
- Summary: Fix run scoping with backward-compatible NULL fallback
- Next Slice: #89 Pipeline-critical tests for canonical flow

=== Slice Start: #89 Pipeline-critical tests for canonical flow ===
- Date: 2026-01-22
- Branch: ralph/m8-89-pipeline-tests
- Notes: Next Phase 1 item per T-004 priority. Tests unblock #108, #109.

=== Iteration 1: Test Suite Implementation Complete ===
- Date: 2026-01-22
- Changes:
  1. Created tests/test_pipeline_canonical_flow.py (29 tests)
     - TestPipelineFlowIntegration (4 tests):
       * test_theme_groups_create_stories_when_large_enough
       * test_theme_groups_create_orphans_when_too_small
       * test_mixed_groups_processed_correctly
       * test_processing_result_metrics_accurate
     - TestStoryCreationServiceBehavior (5 tests):
       * test_min_group_size_boundary_story (exactly MIN_GROUP_SIZE → story)
       * test_min_group_size_boundary_orphan (MIN_GROUP_SIZE-1 → orphan)
       * test_empty_conversation_id_rejected
       * test_orphan_integration_used_when_available
       * test_orphan_fallback_on_integration_failure
     - TestQualityGateRegression (4 tests):
       * test_confidence_score_stored_on_story
       * test_confidence_below_threshold_creates_orphan
       * test_evidence_validation_failure_routes_to_orphan
       * test_quality_gate_result_captures_failure_reason
     - TestEvidenceValidator (6 tests):
       * test_valid_samples_pass
       * test_missing_id_fails
       * test_missing_excerpt_fails
       * test_placeholder_excerpt_fails
       * test_empty_samples_fails
       * test_coverage_calculated_correctly
     - TestRunScopingIsolation (3 tests):
       * test_stories_linked_to_pipeline_run_id
       * test_processing_result_tracks_story_ids
       * test_separate_runs_create_separate_stories
     - TestPMReviewMetrics (2 tests):
       * test_pm_review_skipped_when_disabled
       * test_pm_review_metrics_initialized
     - TestErrorHandling (2 tests):
       * test_exception_in_one_group_doesnt_stop_others
       * test_story_service_exception_captured
     - TestConstants (3 tests):
       * test_min_group_size_is_3
       * test_default_confidence_threshold_is_50
       * test_processing_result_has_quality_gate_metrics
- Test Results:
  - All 29 new tests PASSED
  - Full backend test suite: 840 passed, 11 skipped, 1 failed (pre-existing latency test)
- Coverage per Issue Acceptance Criteria:
  [x] Tests validate canonical pipeline flow end-to-end with minimal fixtures
  [x] Quality gate logic is exercised (confidence, evidence validation, orphan path)
  [x] Run scoping isolation is tested (no cross-contamination)
  [x] Tests are stable and do not depend on live API calls
- Commit: 45dd93e
- Push: Complete (branch: ralph/m8-89-pipeline-tests)

=== Iteration 2: PR + 5-Personality Review ===
- Date: 2026-01-22
- PR URL: https://github.com/paulyokota/FeedForward/pull/113
- Review Round 1:
  - Reginald (Architect): BLOCK - Mock DB cursor, empty ID verification, orphan assertion
  - Sanjay (Security): APPROVE - No security concerns
  - Quinn (QA): BLOCK - End-to-end test (acknowledged), evidence validation assertion
  - Dmitri (Minimalist): BLOCK - Stylistic concerns (later retracted)
  - Maya (Maintainer): APPROVE - Excellent maintainability
- Fixes Applied (commit 6babb88):
  1. Mock DB cursor: Use MagicMock with proper __enter__/__exit__ pattern
  2. Empty ID test: Add create.call_count == 0 assertion
  3. Orphan fallback: Split into two assertions (fallbacks AND creation)
  4. Evidence validation: Add orphan creation verification
- Review Round 2: All 5 reviewers APPROVE
- Status: CONVERGED in 2 rounds
- PR #113 MERGED (squash) to main

=== Slice Complete: #89 ===
- Date: 2026-01-22
- Final Commit: 5033f5a (squash merge)
- Summary: 29 pipeline-critical tests for canonical flow (classification → theme → story)
- Unblocks: #108 (embedding clustering), #109 (PM review)
- Next Slice: Select from SLICE.md

=== Slice Start: #104 Theme extraction quality gates + error propagation to UI ===
- Date: 2026-01-22
- Branch: ralph/m8-104-quality-gates
- Notes: Phase 1 issue per T-004 priority. Blocks #110.
