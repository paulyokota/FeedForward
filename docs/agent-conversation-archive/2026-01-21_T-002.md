# T-002 – Architecture: Canonical pipeline + story creation unification

---

### Message
- **Timestamp:** 2026-01-21T16:53:47Z
- **Agent:** Human
- **Topic:** T-002 (Architecture – Canonical pipeline + story creation unification)
- **Intent:** exploration
- **Respond Requested:** Yes (Claude Code)
- **Decision Impact:** High

#### Question
Should we declare a single canonical pipeline and unify story creation around `StoryCreationService` (with quality gates), and if so what sequencing minimizes risk while improving maintainability?

#### Context
- Claude roadmap: N/A
- Codex roadmap: N/A
- Additional context: New architecture review doc drafted at `docs/architecture/codebase-structure-review.md`.

#### What We Need
- Claude Code: Review the doc, propose a recommended architecture direction and a minimal-risk sequence of changes.
- Codex: N/A (unless Claude asks for an implementation risk check).

#### Turn Status
Complete – awaiting Claude Code
---

### Message
- **Timestamp:** 2026-01-21T17:15:00Z
- **Agent:** Claude Code
- **Topic:** T-002 (Architecture – Canonical pipeline + story creation unification)
- **Intent:** feedback
- **Respond Requested:** Yes (Human)
- **Decision Impact:** High

#### Content
I've reviewed the architecture doc and the actual code. **The doc contains a factual error that changes the recommendations.**

**What the doc says:** "UI pipeline uses `PipelineIntegrationService` (minimal story creation)."

**What the code actually shows:** The UI pipeline router (`src/api/routers/pipeline.py:271-293`) already uses `StoryCreationService`, not `PipelineIntegrationService`. The migration described in "Concrete Next Steps → Step 2" is already done.

`PipelineIntegrationService` exists but is essentially orphaned code—exported from `__init__.py`, has tests, but no production callers.

#### Revised Assessment

Given the actual state, here's my take:

**Agree with:**

- Declaring one canonical pipeline (two-stage via `pipeline.py` is the de facto canonical path)
- Wiring in quality gates (confidence scoring, orphan integration, evidence validation)
- Clarifying module boundaries (ingestion in `src/`, story lifecycle in `src/story_tracking/`)

**Push back on:**

1. **"Migrate UI story creation to StoryCreationService"** — Already done. This step can be struck.
2. **"Convert PipelineIntegrationService into a thin wrapper or retire it"** — I recommend **retire**. It has no production callers, and StoryCreationService already has richer capabilities (PM review, dual-format, evidence, orphan lifecycle). Keeping it as a "thin wrapper" adds indirection for no benefit.
3. **The sequencing assumes more work than exists.** Step 2 is done; what remains is wiring quality gates and cleanup.

#### Proposed Revised Sequence

1. **Delete `PipelineIntegrationService`** — Clean up orphaned code. Update `__init__.py` exports. Migrate or delete its tests to cover `StoryCreationService` equivalents.

2. **Wire quality gates into the canonical pipeline** — Add `ConfidenceScorer`, `OrphanIntegrationService`, `EvidenceValidator` calls in `_run_pm_review_and_story_creation()` or inside `StoryCreationService.process_theme_groups()`.

3. **Deprecate legacy `src/pipeline.py`** — Mark for removal. The two-stage pipeline is canonical.

4. **Document the canonical flow** — Update `docs/architecture.md` to reflect reality: one pipeline, one story creation service.

#### Risk Notes

- **Deleting PipelineIntegrationService is low risk** — no production callers. Test coverage will reveal any hidden dependencies.
- **Quality gate wiring is medium risk** — requires deciding where gates live (pipeline orchestration vs service internals). I recommend gates live in the service (StoryCreationService) so all callers benefit.

#### Roadmap Alignment

- Claude roadmap: N/A
- Codex roadmap: N/A
- Changes from my original roadmap: N/A (no prior roadmap on this topic)

#### Supporting Evidence

- `src/api/routers/pipeline.py:271-293` — UI pipeline uses StoryCreationService
- `src/story_tracking/services/__init__.py:34` — PipelineIntegrationService exported but unused
- Grep for `PipelineIntegrationService` — only test files and docs reference it

#### Turn Status

Complete – awaiting Codex
---

### Message
- **Timestamp:** 2026-01-21T17:18:01Z
- **Agent:** Codex
- **Topic:** T-002 (Architecture – Canonical pipeline + story creation unification)
- **Intent:** proposal
- **Respond Requested:** Yes (Human)
- **Decision Impact:** High

#### Content
I agree with Claude’s correction: the UI pipeline already uses `StoryCreationService` via `process_theme_groups`, so “migrate story creation” is done. The remaining opportunity is to consolidate the canonical flow and wire quality gates into the existing path, then delete legacy entry points/services to prevent drift.

**Recommended sequence (minimal risk):**

1. **Declare canonical pipeline** as `src/api/routers/pipeline.py` + `src/two_stage_pipeline.py` + `StoryCreationService.process_theme_groups`. Update docs to reflect this.
2. **Wire quality gates into StoryCreationService** (best home so all callers benefit): confidence scoring, orphan integration, and evidence validation.
3. **Retire `PipelineIntegrationService`** (no production callers). Remove exports and tests or migrate test coverage.
4. **Deprecate `src/pipeline.py`** as legacy single-stage CLI path; update docs that still point to it as “the” pipeline.

**Why this sequencing:** it avoids breaking UI runs (Step 1), adds quality value with limited surface area (Step 2), then reduces codebase ambiguity (Steps 3–4).

**Decision needed:** confirm whether `src/pipeline.py` should be retired or kept as a legacy CLI tool. I recommend deprecate + remove to avoid drift unless it serves a distinct ops use case.

#### Roadmap Alignment

- Claude roadmap: N/A
- Codex roadmap: N/A
- Changes from my original roadmap: N/A

#### Supporting Evidence

- `src/api/routers/pipeline.py:271-293` — UI pipeline uses StoryCreationService.process_theme_groups
- `src/story_tracking/services/story_creation_service.py:235` — process_theme_groups (UI entry point)
- `src/two_stage_pipeline.py:327` — canonical async pipeline used by UI
- `src/pipeline.py` — legacy single-stage CLI
- `src/story_tracking/services/pipeline_integration.py` — no production callers found

#### Turn Status

Complete – awaiting Claude Code
---

### Message
- **Timestamp:** 2026-01-21T17:25:00Z
- **Agent:** Claude Code
- **Topic:** T-002 (Architecture – Canonical pipeline + story creation unification)
- **Intent:** resolution
- **Respond Requested:** Yes (Human)
- **Decision Impact:** High

#### Content

**We've converged.** Codex and I agree on the analysis and sequencing. Here's the consolidated recommendation:

**Agreed Sequence:**

1. Declare canonical pipeline (docs update)
2. Wire quality gates into `StoryCreationService`
3. Retire `PipelineIntegrationService`
4. Deprecate/remove `src/pipeline.py`

**On the `src/pipeline.py` question:** I recommend **retire**, not just deprecate. Reasons:

- It's single-stage (classification only)—no theme extraction, no story creation
- The two-stage pipeline (`src/two_stage_pipeline.py`) can serve any CLI use case via `python -m src.two_stage_pipeline`
- Keeping it invites confusion about which pipeline is "real"
- If ops needs a lightweight classification-only CLI, that's a feature request for the canonical pipeline (add a `--classification-only` flag), not a reason to maintain parallel code

**Human decisions needed:**

1. Approve the 4-step sequence?
2. Confirm `src/pipeline.py` should be retired (not just deprecated)?

#### Disagreement Summary

None—agents aligned.

#### Roadmap Alignment

- Claude roadmap: N/A
- Codex roadmap: N/A
- Changes from my original roadmap: N/A

#### Supporting Evidence

- `src/pipeline.py:1-10` — single-stage CLI (classification only)
- `src/two_stage_pipeline.py` — full-featured async pipeline usable from CLI

#### Turn Status

Complete – awaiting human decision
---

### Message
- **Timestamp:** 2026-01-21T17:24:04Z
- **Agent:** Human
- **Topic:** T-002 (Architecture – Canonical pipeline + story creation unification)
- **Intent:** resolution
- **Respond Requested:** No
- **Decision Impact:** High

#### Content
Decision: Approve the 4-step sequence and **retire** `src/pipeline.py`.

1) Declare canonical pipeline (docs update)
2) Wire quality gates into `StoryCreationService`
3) Retire `PipelineIntegrationService`
4) Deprecate/remove `src/pipeline.py` (retire, not just deprecate)

Rationale: Single canonical pipeline reduces drift; UI already uses `StoryCreationService`, so wiring gates there maximizes coverage; legacy services are unused and confusing.

#### Roadmap Alignment
- Claude roadmap: N/A
- Codex roadmap: N/A
- Changes from my original roadmap: N/A

#### Supporting Evidence
- `src/api/routers/pipeline.py:271-293`
- `src/story_tracking/services/story_creation_service.py:235`
- `src/two_stage_pipeline.py:327`
- `src/pipeline.py:1-10`

#### Turn Status
Complete – ready to archive
---
