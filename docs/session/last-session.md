# Last Session Summary

**Date**: 2026-01-26
**Branch**: main

## Active Pipeline Run

**Run 85** is running (started 08:34 EST):

- 45 days of data (Dec 12, 2025 → Jan 26, 2026)
- Check status: `curl -s http://localhost:8000/api/pipeline/status/85`
- This is a BIG run — expect significant time for classification + embedding + facet phases

## Current State

### The Core Problem: Hybrid Clustering Fragmentation

Hybrid clustering **runs without errors** but produces severely fragmented output:

- 77% of clusters are singletons (size 1)
- Only ~6% of clusters meet MIN_GROUP_SIZE=3
- Double-fragmentation from: embedding clustering (distance_threshold=0.5) → facet sub-grouping (action_type + direction)

**Run 84 results** (7 days, 306 conversations):

- 117 actionable → 90 hybrid clusters → 0 hybrid stories, 84 hybrid orphans
- 1 story came from legacy signature fallback (not hybrid)
- Size distribution: 69 size-1, 15 size-2, 3 size-3, 2 size-4, 1 size-5

### Why Run 85?

Larger sample (45 days) should:

1. Give more data points for pattern analysis
2. Potentially produce larger clusters (more conversations per topic)
3. Provide better signal for tuning decisions

### Unresolved Mystery

Run 84 produced BOTH hybrid orphans AND signature results (same timestamp). Code shows either/or logic. Couldn't determine root cause without server logs. May have been an exception during `process_hybrid_clusters` that was caught, returning None after orphans were already committed.

## Key Files

| File                                                    | Purpose                                                             |
| ------------------------------------------------------- | ------------------------------------------------------------------- |
| `src/services/hybrid_clustering_service.py`             | Two-stage clustering algorithm                                      |
| `src/story_tracking/services/story_creation_service.py` | Story/orphan creation from clusters                                 |
| `src/api/routers/pipeline.py`                           | Pipeline orchestration, lines 791-902 for hybrid vs signature logic |
| `scripts/diagnose_run.py`                               | NEW: Diagnostic script for investigating run results                |

## Tuning Levers (Not Yet Adjusted)

1. **distance_threshold** (default 0.5) — lower = more clusters, higher = fewer larger clusters
2. **MIN_GROUP_SIZE** (default 3) — minimum conversations to become a story
3. **Facet sub-grouping** — currently splits by action_type + direction, causes fragmentation

## Next Steps

1. Wait for Run 85 to complete
2. Analyze results with `python scripts/diagnose_run.py 85`
3. Compare cluster size distribution to Run 84
4. If still fragmented, consider:
   - Increasing distance_threshold (e.g., 0.6 or 0.7)
   - Relaxing or removing facet sub-grouping
   - Lowering MIN_GROUP_SIZE to 2 (temporary, for analysis)

## Session Notes

- Created `scripts/diagnose_run.py` for investigating pipeline run results
- Migration 016 was committed earlier (raw component columns)
- The approach isn't fundamentally broken — it's a tuning problem

---

_Auto-generated by Developer Kit session management_
