# Last Session Summary

**Date**: 2026-01-28 22:55
**Branch**: main

## Goal

Salvage pipeline run 95 after theme storage failures; investigate parallel extraction race condition

## Progress

- Completed: Run 95 salvaged and completed (543 themes, 15 stories, 402 orphans)
- Completed: Fixed 2 additional bugs discovered during run
- Completed: Documented race condition issue (#151)
- Pending: Implement Option 7 (separate signature generation phase) to fix race condition

## Bugs Fixed This Session

### Bug 1: Missing unique constraint on context_usage_logs.theme_id

- **Symptom**: `ON CONFLICT (theme_id)` failed because no unique constraint existed
- **Fix**: `ALTER TABLE context_usage_logs ADD CONSTRAINT context_usage_logs_theme_id_unique UNIQUE (theme_id)`
- **Note**: Schema change applied directly, not via migration

### Bug 2: Missing conversation_id in context_usage_logs INSERT

- **Symptom**: `NOT NULL violation` on conversation_id column
- **Fix**: Added `theme.conversation_id` to INSERT tuple and column list
- **Commit**: 231831d

## Key Discovery: Parallel Extraction Race Condition

Issue #148 fix introduced parallelization for theme extraction (10x speedup). However, this created a race condition:

1. Two threads process similar issues simultaneously
2. Both check for existing signatures, both find nothing
3. Both create "new" signatures independently
4. Result: Duplicate signatures like `multi_network_scheduling_failure` vs `multinetwork_scheduling_failure` (98% similar)

**Impact**: Fragments groups that should be together, potentially preventing story formation when groups fall below 3+ threshold. May explain high orphan count (402) vs low story count (15).

**Documented in**: Issue #151

## Run 95 Final Results

| Metric                    | Count |
| ------------------------- | ----- |
| Conversations classified  | 1440  |
| Themes extracted          | 543   |
| Themes filtered (quality) | 13    |
| Stories created           | 15    |
| Orphans created           | 402   |
| Unique signatures         | 323   |

## Commits This Session

- `231831d` - fix: add conversation_id to context_usage_logs INSERT
- `b08c713` - fix: correct type mismatches in theme storage INSERT (from earlier in session)

## Next Steps

1. Decide: Implement Option 7 (separate signature phase) or roll back to sequential extraction
2. If rolling back: Change concurrency from 20 to 1 in pipeline.py
3. If implementing Option 7: Follow plan in issue #151

---

_Auto-generated by Developer Kit session management_
