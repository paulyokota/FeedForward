# Session: Issue #147 - Test Suite Optimization

**Date:** 2026-01-30
**Issue:** #147 - Test suite bloat blocking iteration velocity
**PR:** #169

## Summary

Speed-run implementation of pytest markers to split the test suite for faster developer iteration. The suite had grown to 1,400 tests taking 10+ minutes, blocking agent feedback loops.

## What Was Done

1. **Created `pytest.ini`** with marker registration:
   - `fast`, `slow`, `integration`, `unit` markers
   - `addopts` for `--showlocals --tb=short`

2. **Marked 10 integration test files as slow**:
   - All `*_integration.py` files
   - `test_pipeline_canonical_flow.py`
   - Dual markers: `[pytest.mark.slow, pytest.mark.integration]`

3. **Updated `CLAUDE.md`** with new test commands

4. **Fixed 3 pre-existing test failures** discovered during verification:
   - `test_run_scoping.py` - regex outdated after Issue #148 async refactor
   - `test_context_gaps_endpoint.py` - import path mismatch for dependency override
   - `test_story_formatter.py` - env var vs module variable caching issue

## Results

| Command                | Tests | Time        |
| ---------------------- | ----- | ----------- |
| `pytest -m "not slow"` | 1,196 | ~5 min      |
| `pytest -m slow`       | 204   | integration |
| `pytest tests/ -v`     | 1,400 | ~10 min     |

## Key Decisions

1. **Marker approach over directory restructure**: Lowest effort, immediate value. No need to move files around.

2. **`slow` as primary, `integration` as secondary**: Most filtering will be `not slow` for fast iteration. `integration` marker added per review feedback for finer-grained selection.

3. **Fixed pre-existing failures inline**: They were quick fixes and blocking the verification step.

## Learnings

1. **Import path matters for dependency injection**: `from api.deps import get_db` vs `from src.api.deps import get_db` are different Python objects. Mocks applied to one don't affect the other.

2. **Module-level variables cache at import time**: `CODA_DOC_ID = os.getenv(...)` runs once at import. Deleting the env var at test time doesn't affect the cached value - must patch the module variable directly.

3. **Source inspection tests are brittle**: `test_run_scoping.py` used regex to find SQL patterns in specific functions. After refactoring (Issue #148), the SQL moved to a different function and the test failed silently until run.

## Files Changed

- `pytest.ini` (new)
- `CLAUDE.md`
- 10 `tests/test_*_integration.py` files
- `tests/test_run_scoping.py`
- `tests/test_context_gaps_endpoint.py`
- `tests/test_story_formatter.py`
